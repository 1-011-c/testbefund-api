openapi: 3.0.0

info:
  title: testbefund-api
  version: 1.0.0-alpha
  contact:
    name: Testbefund
    url: 'https://www.testbefund.de'
    email: anfragen@testbefund.de
  description: This is the reference server to manage testings and findings in the testbefund infrastructure.

servers:
  - url: 'http://localhost:3000'

tags:
  - name: testing
    description: Parts of the API responsible for the management of testings and findings.
  - name: administration
    description: Parts of the API responsible for the management of organizational tasks.

paths:
  /v1/testing/auth:
    get:
      summary: Checks authorization for protected resources.
      tags:
        - testing
      responses:
        '204':
          description: The client has sufficient permissions to access protected resources of this API.
        '401':
          description: The client lacks sufficient permissions to access protected resources of this API.
      operationId: isAuthenticated
      description: Validates if the client has sufficient permission to access the protected resources of this API.
    parameters: []

  /v1/testing/container:
    post:
      summary: Creates a TestingContainer.
      operationId: createTestingContainer
      responses:
        '200':
          description: The server returns the successfully created TestingContainer.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TestbefundTestingContainer'
      description: Creates and registers a new TestingContainer.
      tags:
        - testing
      security:
        - OIDC: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TestbefundTestingContainerDefinition'
        description: The container definition for the container that is going to be created. The full container is returned upon creation.

  /v1/finding/{read-id}:
    parameters:
      - schema:
          type: string
        name: read-id
        in: path
        required: true
        description: The read-id for the expected FindingContainer to be returned.
    get:
      summary: Returns the FindingContainer.
      tags:
        - testing
      responses:
        '200':
          description: The associated FindingContainer for the given read-id was found and is returned in the content.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TestbefundFindingContainer'
        '404':
          description: There was no associated FindingContainer found for the given read-id.
      operationId: getFindingContainer
      description: Returns the FindingContainer associated to the given read-id.

  /v1/testing/{write-id}:
    parameters:
      - schema:
          type: string
        name: write-id
        in: path
        required: true
        description: The write-id for the expected TestingContainer to be returned.
    get:
      summary: Returns TestingContainer.
      tags:
        - testing
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TestbefundTestingContainer'
      operationId: getTestingContainer
      description: 'Returns a writeable test container, containing both read and write information.'

  /v1/testing/container/{write-id}/sample/{test-id}/{testing-result}:
    parameters:
      - schema:
          type: string
        name: write-id
        in: path
        required: true
      - schema:
          type: string
        name: test-id
        in: path
        required: true
      - schema:
          $ref: '#/components/schemas/TestbefundFindingResult'
        name: testing-result
        in: path
        required: true
    post:
      summary: Update Test
      tags:
        - testing
      responses:
        '204':
          description: No Content
      operationId: updateTesting
      description: Updates the result of a single test container

  /v1/testing/container/batch-update:
    post:
      summary: Container Batch Update
      operationId: updateContainerBatch
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TestbefundTestingContainer'
      tags:
        - testing
      description: Batch updates a few containers. Protected testbefund API.
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TestbefundUpdateFindingRequest'

  /v1/organization:
    get:
      summary: Organizations
      tags:
        - administration
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TestbefundIssuingOrganization'
      operationId: getAllOrganizations
      description: Returns all organizations
    parameters: []
    post:
      summary: Create Organization
      operationId: createOrganization
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TestbefundIssuingOrganization'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TestbefundIssuingOrganization'
        description: ''
      tags:
        - administration
      description: Creates a new organization

  /v1/organization/{id}:
    parameters:
      - schema:
          type: string
        name: id
        in: path
        required: true
    get:
      summary: Your GET endpoint
      tags:
        - administration
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TestbefundIssuingOrganization'
      operationId: getOrganizationById
      description: Returns a single organization by id
    delete:
      summary: ''
      operationId: deleteOrganization
      responses:
        '200':
          description: OK
      description: Deletes an organization
      tags:
        - administration

components:
  schemas:
    TestbefundIssuingOrganization:
      title: TestbefundIssuingOrganization
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        address:
          type: string
        phone:
          type: string
        email:
          type: string
        openingHours:
          type: string
        homepage:
          type: string
      description: The issuing organization is responsible for the test and the test results. A user may use this as contact in case of question or if they need information about their test. Testbefund acts as platform, the issuing organization is responsible for the whole test procedure.

    TestbefundTestingDefinition:
      title: TestbefundTestingDefinition
      type: object
      description: A single test definition
      properties:
        title:
          type: string
        icdCode:
          type: string

    TestbefundTestingContainerDefinition:
      title: TestbefundTestingContainerDefinition
      type: object
      description: A single container definition, which is used to create testing containers.
      properties:
        testingDefinitions:
          type: array
          items:
            $ref: '#/components/schemas/TestbefundTestingDefinition'
        issuingOrganization:
          type: string

    TestbefundFindingContainer:
      title: TestbefundFindingContainer
      type: object
      description: Read-Only data for a testing-container. Contains aggregated meta-data to inform the user about their status.
      properties:
        readId:
          type: string
        dateTime:
          type: string
          format: date-time
        issuer:
          $ref: '#/components/schemas/TestbefundIssuingOrganization'
        findings:
          type: array
          items:
            $ref: '#/components/schemas/TestbefundFinding'

    TestbefundFinding:
      title: TestbefundFinding
      type: object
      properties:
        title:
          type: string
        icdCode:
          type: string
        status:
          $ref: '#/components/schemas/TestbefundFindingStatus'
        result:
          $ref: '#/components/schemas/TestbefundFindingResult'
      description: A single finding (a test with a result). The result of the finding will be known once the status is DONE. Finding result will be UNKNOWN as long as the finding status is REVIEW_PENDING or IN_PROGRESS.

    TestbefundFindingResult:
      type: string
      title: TestbefundFindingResult
      enum:
        - UNKNOWN
        - POSITIVE
        - NEGATIVE
      description: Result of a finding, can be POSITIVE or NEGATIVE. If result is not known yet, it will be UNKNOWN.

    TestbefundFindingStatus:
      title: TestbefundFindingStatus
      type: string
      enum:
        - IN_PROGRESS
        - REVIEW_PENDING
        - DONE

    TestbefundTestingContainer:
      title: TestbefundTestingContainer
      type: object
      description: Writeable testing container
      properties:
        writeId:
          type: string
        readId:
          type: string
        testingSamples:
          type: array
          items:
            $ref: '#/components/schemas/TestbefundTesting'
        issuer:
          $ref: '#/components/schemas/TestbefundIssuingOrganization'

    TestbefundTesting:
      title: TestbefundTesting
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        currentStatus:
          $ref: '#/components/schemas/TestbefundFindingResult'
        icdCode:
          type: string

    TestbefundUpdateFindingRequest:
      title: TestbefundUpdateFindingRequest
      type: object
      description: Helper type to aggregate multiple findings for a batched findings update request.
      properties:
        writeId:
          type: string
        findings:
          type: array
          items:
            $ref: '#/components/schemas/TestbefundUpdateSingleFinding'

    TestbefundUpdateSingleFinding:
      title: TestbefundUpdateSingleFinding
      type: object
      description: Helper type for a single finding update request.
      properties:
        title:
          type: string
        testingResult:
          $ref: '#/components/schemas/TestbefundFindingResult'

  securitySchemes:
    OIDC:
      type: openIdConnect
      openIdConnectUrl: 'https://sts.windows.net/9cab6333-480d-4255-9147-29bfca59f878/'
